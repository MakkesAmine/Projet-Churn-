# DÃ©finition des variables
PYTHON=python3
VENV=venv
REQUIREMENTS=requirements.txt
TRAIN_PATH=churn-bigml-80.csv
TEST_PATH=churn-bigml-20.csv

# Variables Docker
IMAGE_NAME=aminemakkes/ml_project
TAG=latest

.PHONY: install data train evaluate test save start-api test-api notebook 
#build run stop push clean

# CrÃ©ation de l'environnement virtuel et installation des dÃ©pendances
install:
	@echo "ğŸ“¦ CrÃ©ation de l'environnement virtuel et installation des dÃ©pendances..."
	@${PYTHON} -m venv ${VENV}
	@. ${VENV}/bin/activate && pip install --upgrade pip && pip install -r ${REQUIREMENTS}

# PrÃ©paration des donnÃ©es
data:
	@echo "ğŸ“Š PrÃ©paration des donnÃ©es..."
	@. ${VENV}/bin/activate && ${PYTHON} main.py --prepare --train_path $(TRAIN_PATH) --test_path $(TEST_PATH)

# EntraÃ®nement du modÃ¨le
train:
	@echo "ğŸ¤– EntraÃ®nement du modÃ¨le..."
	@. ${VENV}/bin/activate && ${PYTHON} main.py --train --train_path $(TRAIN_PATH) --test_path $(TEST_PATH)

# Ã‰valuation du modÃ¨le
evaluate:
	@echo "ğŸ“ˆ Ã‰valuation du modÃ¨le..."
	@. ${VENV}/bin/activate && ${PYTHON} main.py --evaluate --train_path $(TRAIN_PATH) --test_path $(TEST_PATH)

# ExÃ©cution des tests
test:
	@echo "ğŸ§ª ExÃ©cution des tests..."
	@. ${VENV}/bin/activate && pytest test_environment.py

# Sauvegarde du modÃ¨le
save:
	@echo "ğŸ’¾ Sauvegarde du modÃ¨le..."
	@. ${VENV}/bin/activate && ${PYTHON} main.py --save churn_model.pkl --train_path $(TRAIN_PATH) --test_path $(TEST_PATH)

# DÃ©marrage de l'API FastAPI
start-api:
	@echo "ğŸš€ DÃ©marrage de l'API FastAPI..."
	@. ${VENV}/bin/activate && uvicorn app:app --reload --host 0.0.0.0 --port 8000 &
	@sleep 3
	@echo "ğŸŒ Ouverture de Swagger..."

mlflow-ui:
	@echo "ğŸŒ Lancement de l'interface MLflow sur http..."
	@. ${VENV}/bin/activate && mlflow ui --host 0.0.0.0 --port 5000

# Nettoyage des fichiers temporaires
clean:
	@echo "ğŸ§¹ Nettoyage des fichiers temporaires..."
	@rm -rf _pycache_ *.pyc *.pyo *.log ${VENV}

# Lancer Jupyter Notebook pour l'exploration
notebook:
	@echo "ğŸ““ Lancement de Jupyter Notebook..."
	@. ${VENV}/bin/activate && jupyter notebook

# ğŸ³ Docker Commands

## Construire l'image Docker
build:
	@echo "ğŸ”¨ Construction de l'image Docker..."
	sudo docker build -t $(IMAGE_NAME):$(TAG) .

## Lancer le conteneur
run:
	@echo "ğŸš€ Lancement du conteneur..."
	sudo docker run -d -p 8000:8000 --name fastapi-app $(IMAGE_NAME):$(TAG)

## Stopper et supprimer le conteneur
stop:
	@echo "ğŸ›‘ ArrÃªt du conteneur..."
	sudo docker stop fastapi-app && sudo docker rm fastapi-app

## Pousser lâ€™image sur Docker Hub
push:
	@echo "ğŸ“¤ PoussÃ©e de l'image sur Docker Hub..."
	sudo docker push $(IMAGE_NAME):$(TAG)

## Nettoyer les images et conteneurs inutiles
docker-clean:
	@echo "ğŸ§¹ Nettoyage des images et conteneurs Docker..."
	sudo docker system prune -f
